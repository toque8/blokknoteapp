name: Build Debug APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Setup Gradle
      run: |
        wget https://services.gradle.org/distributions/gradle-8.5-bin.zip -P /tmp
        unzip -d /opt/gradle /tmp/gradle-*.zip
        echo "GRADLE_HOME=/opt/gradle/gradle-8.5" >> $GITHUB_ENV
        echo "/opt/gradle/gradle-8.5/bin" >> $GITHUB_PATH
        
        if [ ! -f "settings.gradle.kts" ]; then
          echo "rootProject.name = \"BlokkNote\"" > settings.gradle.kts
          echo "include(\":app\")" >> settings.gradle.kts
        fi
        
        if [ ! -f "build.gradle.kts" ]; then
          cat > build.gradle.kts << 'EOF'
          // Top-level build file where you can add configuration options common to all sub-projects/modules.
          plugins {
              id("com.android.application") version "8.1.4" apply false
              id("org.jetbrains.kotlin.android") version "1.9.0" apply false
              id("com.google.dagger.hilt.android") version "2.48" apply false
          }
          
          tasks.register("clean", Delete::class) {
              delete(rootProject.buildDir)
          }
          EOF
        fi
        
        if [ ! -f "app/build.gradle.kts" ]; then
          echo "Ошибка: Нет app/build.gradle.kts файла!" >&2
          exit 1
        fi
    
    - name: Grant permissions
      run: |
        # Даем права на исполнение всем скриптам
        chmod -R +x . || true
    
    - name: Build APK with Gradle
      run: |
        # Собираем APK напрямую через Gradle
        gradle --version
        gradle :app:assembleDebug --stacktrace --no-daemon
      env:
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.10-7/x64
    
    - name: Find and Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: |
          **/build/outputs/apk/**/*.apk
          **/build/outputs/**/*.apk
          app/build/outputs/**/*.apk
        if-no-files-found: warn
        retention-days: 7
