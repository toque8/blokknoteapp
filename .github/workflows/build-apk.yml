name: Build Debug APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug project structure
      run: |
        echo "ðŸ” Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
        echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
        ls -la
        echo ""
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ app/:"
        ls -la app/
        echo ""
        echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ app/src/:"
        ls -la app/src/
        echo ""
        echo "ðŸ“ ÐŸÐ¾Ð¸ÑÐº AndroidManifest.xml:"
        find . -name AndroidManifest.xml
        echo ""
        echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ð°:"
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "âœ… Ð¤Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        else
          echo "âŒ Ð¤Ð°Ð¹Ð» Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
        fi

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    
    - name: Fix project structure if needed
      run: |
        # Ð•ÑÐ»Ð¸ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ, Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ð¼ ÐµÐ³Ð¾
        if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
          echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð² ÐºÐ¾Ñ€Ð½Ðµ app/
          if [ -f "app/AndroidManifest.xml" ]; then
            mkdir -p app/src/main
            mv app/AndroidManifest.xml app/src/main/
          fi
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð² src/main/
          if [ -f "src/main/AndroidManifest.xml" ]; then
            mkdir -p app/src/main
            mv src/main/AndroidManifest.xml app/src/main/
          fi
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð² app/main/
          if [ -f "app/main/AndroidManifest.xml" ]; then
            mkdir -p app/src/main
            mv app/main/AndroidManifest.xml app/src/main/
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ, ÐµÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
          if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
            echo "âš ï¸ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ AndroidManifest.xml, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹..."
            mkdir -p app/src/main
            cat > app/src/main/AndroidManifest.xml <<EOF
            <?xml version="1.0" encoding="utf-8"?>
            <manifest xmlns:android="http://schemas.android.com/apk/res/android"
                package="space.blokknote">
                <application
                    android:allowBackup="true"
                    android:label="@string/app_name"
                    android:supportsRtl="true">
                    <activity
                        android:name=".MainActivity"
                        android:exported="true">
                        <intent-filter>
                            <action android:name="android.intent.action.MAIN" />
                            <category android:name="android.intent.category.LAUNCHER" />
                        </intent-filter>
                    </activity>
                </application>
            </manifest>
            EOF
          fi
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
        mkdir -p app/src/main/res/values
        if [ ! -f "app/src/main/res/values/strings.xml" ]; then
          cat > app/src/main/res/values/strings.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Blokknote</string>
          </resources>
          EOF
        fi

    - name: Build debug APK
      run: ./gradlew assembleDebug --no-daemon --max-workers=1
      env:
        TERM: dumb
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
